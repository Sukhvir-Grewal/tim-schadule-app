{
    "sourceFile": "node_version/public/script.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1723144584777,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1723144738455,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,9 +53,9 @@\n /*\n  * Next 4 functions will from Official Quickstart  \n  *     > https://developers.google.com/calendar/api/quickstart/js\n  *     > https://developers.google.com/gmail/api/quickstart/js\n- * NOTE: Code had been altered accordidly like use of localStorage for ease in login,\n+ * NOTE: Code had been altered accordingly like use of localStorage for ease in login,\n  * including document manipulation\n */\n function gapiLoaded() {\n     gapi.load(\"client\", initializeGapiClient);\n@@ -312,9 +312,9 @@\n         throw new Error(\"Invalid schedule line format\");\n     }\n }\n \n-// Dont need to explain this one ^^\n+// Don't need to explain this one ^^\n function convertTo24Hour(time) {\n     if (!time) {\n         throw new Error(\"Invalid time format\");\n     }\n"
                }
            ],
            "date": 1723144584777,
            "name": "Commit-0",
            "content": "let CLIENT_ID\nlet API_KEY\n\nconst DISCOVERY_DOCS = [\n    \"https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest\",\n    \"https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest\",\n];\n\nconst SCOPES = [\n    \"https://www.googleapis.com/auth/calendar.events\",\n    \"https://www.googleapis.com/auth/gmail.readonly\",\n];\n\nlet tokenClient;\nlet gapiInited = false;\nlet gisInited = false;\nlet startDate = \"\";\nlet endDate = \"\";\n\ndocument.getElementById(\"authorize_button\").style.visibility = \"hidden\";\n\n\n/*\n * This code Servers the purpose of getting both Env variables\n * including initializing the client Token\n*/\nasync function fetchEnvVariables() {\n    try {\n        const response = await fetch('/env');\n        const env = await response.json();\n        CLIENT_ID = env.clientId;\n        API_KEY = env.apiKey;\n\n        tokenClient = google.accounts.oauth2.initTokenClient({\n            client_id: CLIENT_ID,\n            scope: SCOPES.join(\" \"),\n            callback: \"\", // defined later\n        });\n\n        // Check for stored token\n        const storedToken = localStorage.getItem(\"gapi_token\")\n        if (storedToken) {\n            gapi.client.setToken(JSON.stringify(storedToken))\n        }\n\n        gisInited = true;\n        maybeEnableButtons();\n    } catch (error) {\n        console.error(\"Error fetching environment variables:\", error);\n    }\n}\n\n/*\n * Next 4 functions will from Official Quickstart  \n *     > https://developers.google.com/calendar/api/quickstart/js\n *     > https://developers.google.com/gmail/api/quickstart/js\n * NOTE: Code had been altered accordidly like use of localStorage for ease in login,\n * including document manipulation\n*/\nfunction gapiLoaded() {\n    gapi.load(\"client\", initializeGapiClient);\n}\n\nasync function initializeGapiClient() {\n    await gapi.client.init({\n        apiKey: API_KEY,\n        discoveryDocs: DISCOVERY_DOCS,\n    });\n    gapiInited = true;\n    maybeEnableButtons();\n}\n\nfunction gisLoaded() {\n    fetchEnvVariables()\n}\n\nfunction maybeEnableButtons() {\n    if (gapiInited && gisInited) {\n        document.getElementById(\"authorize_button\").style.visibility = \"visible\";\n        document.querySelector(\".after-authorize\").style.display = \"flex\";\n    }\n}\n\nfunction handleAuthClick() {\n    tokenClient.callback = async (resp) => {\n        if (resp.error !== undefined) {\n            console.error(\"Error during authorization:\", resp);\n            return;\n        }\n\n        // save the token to locakstorage\n        const token = gapi.client.getToken()\n        if (token) {\n            localStorage.setItem(\"gapi_token\", JSON.stringify(token))\n        }\n\n        document.getElementById(\"authorize_button\").style.display = \"none\";\n        document.querySelector(\".after_authorize\").style.display = \"flex\";\n\n        await getRecentEmailFromSender();\n    };\n\n    if (gapi.client.getToken() === null) {\n        tokenClient.requestAccessToken({ prompt: \"consent\" });\n    } else {\n        tokenClient.requestAccessToken({ prompt: \"\" });\n    }\n}\n\n// NOTE: Custom functions starts from here\n\nasync function addEvent(event) {\n    try {\n        const response = await gapi.client.calendar.events.insert({\n            calendarId: \"primary\",\n            resource: event,\n        });\n        // console.log(\"Event created: \", response.result.htmlLink);\n    } catch (err) {\n        console.error(\"Error contacting the Calendar service: \", err.message);\n    }\n}\n\n/*\n * Checks if the Event already exists in the place, \n * in case someone tries to push the event again\n*/\nasync function checkDuplicateEvent(newEvent) {\n    const calendar = gapi.client.calendar;\n\n    try {\n        // List events within the time range of the new event\n        const response = await calendar.events.list({\n            calendarId: \"primary\",\n            timeMin: newEvent.start.dateTime,\n            timeMax: newEvent.end.dateTime,\n            singleEvents: true,\n            orderBy: \"startTime\",\n        });\n\n        const events = response.result.items;\n\n        if (events.length > 0) {\n            // Check if any event matches the new event's details\n            const duplicateEvent = events.find((event) => {\n\n                const startTimeMatches =\n                    Math.abs(\n                        new Date(event.start.dateTime) -\n                        new Date(newEvent.start.dateTime)\n                    ) < 60000; // 1 minute tolerance\n                const endTimeMatches =\n                    Math.abs(\n                        new Date(event.end.dateTime) -\n                        new Date(newEvent.end.dateTime)\n                    ) < 60000;\n\n                // Compare other details\n                return (\n                    event.summary === newEvent.summary &&\n                    startTimeMatches &&\n                    endTimeMatches &&\n                    event.location === newEvent.location\n                );\n            });\n\n            if (duplicateEvent) {\n                console.log(\"Duplicate event found. Event not added.\");\n                return;\n            }\n        }\n\n        // Everything looks good, send the sucker^^\n        await addEvent(newEvent);\n        console.log(\"Event added successfully.\");\n    } catch (error) {\n        console.error(\"Error checking or adding event:\", error.message);\n    }\n}\n\n/*\n * NOTE: Following logic is only for specific sender since i need to Extract\n * the schedule from the email, The code can be changed easily if the received email\n * have different format of schedule\n * \n * This code extract emails from noreply@clearviewconnect.com (my workplace schedule sender)\n * and gets the top email and extract the only lines starting from months and push line by line\n * in next function to get date and time separated\n*/\nasync function getRecentEmailFromSender() {\n    try {\n        // List messages from the specified sender\n        const res = await gapi.client.gmail.users.messages.list({\n            userId: \"me\",\n            q: `from:noreply@clearviewconnect.com`,\n            maxResults: 1,\n            orderBy: \"date\",\n        });\n\n        const messages = res.result.messages;\n        if (!messages || messages.length === 0) {\n            console.log(\"No message found\");\n            return;\n        }\n\n        // Get the most recent message\n        const messageId = messages[0].id;\n        const messageRes = await gapi.client.gmail.users.messages.get({\n            userId: \"me\",\n            id: messageId,\n        });\n\n        // NOTE: Learned new thing ^^\n        const emailData = messageRes.result;\n        const encodedBody = emailData.payload.parts\n            ? emailData.payload.parts[0].body.data\n            : emailData.payload.body.data;\n\n        // Decode the body\n        const decodedBody = atob(\n            encodedBody.replace(/-/g, \"+\").replace(/_/g, \"/\")\n        );\n\n        // Extract the schedule details\n        const scheduleLines = decodedBody\n            .split(\"\\n\")\n            .filter((line) =>\n                line.match(\n                    /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\s+\\d{2}:/\n                )\n            );\n\n        if (scheduleLines.length === 0) {\n            console.log(\"No schedule lines found.\");\n            return;\n        }\n\n        // Parse the schedule lines and add events\n        for (const line of scheduleLines) {\n            try {\n                const event = parseScheduleLine(line);\n                if (event) {\n                    await checkDuplicateEvent(event);\n                }\n            } catch (error) {\n                console.error(\"Error parsing or adding event:\", error.message);\n            }\n\n            // NOTE: For Further Development\n\n            // endDate = line.split(\":\")[0].trim();\n        }\n        /*\n            startDate = scheduleLines[0].split(\":\")[0].trim();\n            document.getElementById(\n            \"content\"\n            ).innerHTML += `Schedule from ${startDate} to ${endDate} has been Posted on calender`;\n        */\n    } catch (error) {\n        console.error(\"Error fetching email:\", error.message);\n    }\n}\n\nfunction parseScheduleLine(line) {\n    try {\n        // Check for \"Not Scheduled\" and skip such lines\n        // NOTE: String can be changed based on how your day off is mentioned in schedule\n        if (line.includes(\"Not Scheduled\")) {\n            console.log(`Skipping non-scheduled day`);\n            return null;\n        }\n\n        // Extract date part and time details\n        const [datePart, rest] = line.split(/:\\s+/);\n        const timeAndDetails = rest.trim();\n\n        // Handle specific cases based on structure\n        // NOTE: Learned new thing ^^\n        const [timeRange] = timeAndDetails.split(/\\s*,\\s*/);\n        const [startTime, endTime] = timeRange\n            .split(\" - \")\n            .map((time) => time.trim());\n\n        // Extract month and day\n        const [month, day] = datePart.split(/\\s+/);\n        const year = new Date().getFullYear();\n        const date = new Date(`${month} ${day}, ${year}`);\n\n        const startDateTime = new Date(date);\n        const endDateTime = new Date(date);\n\n        const [startHours, startMinutes] = convertTo24Hour(startTime);\n        const [endHours, endMinutes] = convertTo24Hour(endTime);\n\n        startDateTime.setHours(startHours, startMinutes);\n        endDateTime.setHours(endHours, endMinutes);\n\n        return {\n            summary: `Tim~Shift`,\n            start: {\n                dateTime: startDateTime.toISOString(),\n                timeZone: \"America/Halifax\",\n            },\n            end: {\n                dateTime: endDateTime.toISOString(),\n                timeZone: \"America/Halifax\",\n            },\n            colorId: \"5\", // Customizable based on interest \n        };\n    } catch (error) {\n        console.error(\"Error parsing schedule line:\", error.message);\n        throw new Error(\"Invalid schedule line format\");\n    }\n}\n\n// Dont need to explain this one ^^\nfunction convertTo24Hour(time) {\n    if (!time) {\n        throw new Error(\"Invalid time format\");\n    }\n\n    const match = time.match(/(\\d{1,2}):(\\d{2})(AM|PM)/i);\n\n    if (!match) {\n        throw new Error(\"Time format does not match\");\n    }\n\n    let [hours, minutes, meridian] = match.slice(1);\n    hours = parseInt(hours, 10);\n    minutes = parseInt(minutes, 10);\n\n    if (meridian.toUpperCase() === \"PM\" && hours < 12) hours += 12;\n    if (meridian.toUpperCase() === \"AM\" && hours === 12) hours = 0;\n\n    return [hours, minutes];\n}\n\n// Animation stuff\nsetTimeout(function() {\n    document?.getElementById(\"authorize_button\").classList.add(\"show\");\n    document?.querySelector(\".logo\").classList.add(\"slideUp\");\n}, 2000);\n"
        }
    ]
}